<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>かめはめ波（Simple Robust）</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; color: white; }
        
        /* エラーログ（最前面） */
        #debug-log {
            position: absolute; top: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.8); color: #00FF00; 
            font-size: 14px; z-index: 10000; pointer-events: none;
            white-space: pre-wrap; padding: 5px; border-bottom: 1px solid #444;
        }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        
        button { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            border: 3px solid #FFF; padding: 15px 50px; font-size: clamp(20px, 5vw, 30px); font-weight: 900; 
            color: #333; border-radius: 50px; cursor: pointer; margin: 15px; pointer-events: auto; transition: transform 0.1s; box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        button:active { transform: scale(0.95); }

        .screen { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 30px; 
            border: 4px solid #00FF00; box-shadow: 0 0 30px #00FF00; margin-top: 5%; pointer-events: auto;
            width: 90%; max-width: 600px; box-sizing: border-box;
        }
        .hidden { display: none !important; }
        
        h1 { color: #00FF00; font-size: clamp(40px, 10vw, 80px); margin: 0 0 20px 0; text-shadow: 0 0 15px white; font-weight: 900; letter-spacing: 5px; text-align: center; }
        p { color: white; font-size: clamp(16px, 4vw, 24px); margin-bottom: 30px; font-weight: bold; text-align: center; line-height: 1.5; }
        .score-val { font-size: clamp(40px, 10vw, 80px); color: #00FFFF; font-weight: 900; text-shadow: 0 0 20px #00FFFF; margin-bottom: 30px; }
        #charge-bar-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; height: 30px; background: rgba(255, 255, 255, 0.2); border-radius: 15px; overflow: hidden; display: none; border: 3px solid white; }
        #charge-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #FFFF00, #FF4500); transition: width 0.1s; }
        .credit { margin-top: 20px; font-size: 12px; color: #AAA; text-align: center; }
        #loading-msg { color: #00FF00; font-size: 18px; font-weight: bold; margin-top: 20px; }
    </style>

    <script>
        function log(msg) {
            console.log(msg);
            var el = document.getElementById('debug-log');
            if(el) el.innerHTML += msg + " | ";
        }
        window.onerror = function(msg, url, line) {
            log("System Error: " + msg);
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
</head>
<body>
    <div id="debug-log">Page Init...<br></div>
    
    <div id="ui-layer">
        <div id="title-screen" class="screen">
            <h1>かめはめ波</h1>
            <p>〜 AI モーションキャプチャ版 〜</p>
            <p style="color:#FFFF00">ハイスコア: <span id="high-score-title">0</span></p>
            
            <button id="init-btn">カメラ起動</button>
            <button id="start-btn" class="hidden">あそぶ！</button>
            
            <div id="loading-msg" class="hidden">AI準備中...</div>
            <div class="credit">音楽素材：魔王魂 / AR Spark</div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h1>おしまい！</h1>
            <div style="font-size: 20px; color:#AAA;">今回のスコア</div>
            <div class="score-val"><span id="final-score">0</span></div>
            <p style="color:#FFFF00">ハイスコア: <span id="high-score-result">0</span></p>
            <button id="return-btn">タイトルへ</button>
        </div>
        <div id="charge-bar-container"><div id="charge-bar"></div></div>
    </div>

    <script>
        // ここからスクリプト開始
        log("Script Reading...");

        const CAM_W = 640; 
        const CAM_H = 480;
        
        let poseNet;
        let poses = [];
        let video;
        let vScale = 1.0; 
        let videoX = 0, videoY = 0;

        let imgWater, imgEnemy1, imgEnemy2, imgBoss, imgBossEnd;
        let bgmNormal, bgmExtra1, bgmBoss, bgmVictory; 
        
        let imagesLoaded = { water: false, enemy1: false, enemy2: false, boss: false, bossEnd: false };
        let soundLoaded = { normal: false, extra1: false, boss: false, victory: false };

        let balloons = [];
        let floatingTexts = []; 
        let score = 0;
        let highScore = 0;
        let timeLeft = 60;
        let gameState = 'INIT'; 
        let trackedPos = [null, null]; 
        
        let chargeTimer = 0;
        let isCharging = false;
        let isFiring = false;
        let fireTimer = 0;
        let cooldownTimer = 0;
        let needsSeparation = false; 
        let osc, noiseOsc;

        let hasCollectedWater = false;
        let waterSpawned = false;
        let warningTextX = 0;
        let extraTimer = 0;
        let boss = null;
        let bossBaseY = 0; 
        let bossIsDead = false;
        let modelIsReady = false;

        // ★ボタンイベントの設定
        window.addEventListener('load', function() {
            log("Window Loaded");
            document.getElementById('init-btn').onclick = startCameraSequence;
            document.getElementById('start-btn').onclick = startGameSystem;
            document.getElementById('return-btn').onclick = returnToTitleSystem;
        });

        // ■■■ カメラ起動シーケンス ■■■
        function startCameraSequence() {
            log("Button Clicked");
            document.getElementById('init-btn').classList.add('hidden');
            document.getElementById('loading-msg').classList.remove('hidden');
            document.getElementById('loading-msg').innerText = "カメラ許可を求めています...";

            if (typeof userStartAudio !== 'undefined') {
                userStartAudio().then(() => log("Audio Started"));
            }

            let constraints = {
                video: { width: { ideal: CAM_W }, height: { ideal: CAM_H } },
                audio: false
            };
            
            if (location.hostname.includes("github.io")) {
                constraints.video.facingMode = "user";
            }

            video = createCapture(constraints, function(stream) { 
                log("Camera OK");
                document.getElementById('loading-msg').innerText = "AIモデル読み込み中...";
                initPoseNet();
            });
            
            if(video) {
                video.size(CAM_W, CAM_H);
                video.hide();
                if(video.elt) video.elt.setAttribute('playsinline', '');
            }
            
            setupSounds();
        }

        function initPoseNet() {
            let options = {
                architecture: 'MobileNetV1', imageScaleFactor: 0.3, outputStride: 16,
                flipHorizontal: true, minConfidence: 0.5, scoreThreshold: 0.5,
                detectionType: 'single', multiplier: 0.75
            };
            
            try {
                poseNet = ml5.poseNet(video, options, modelReady);
                poseNet.on('pose', function(results) { poses = results; });
            } catch(e) {
                log("ML5 Err: " + e);
            }
        }

        function modelReady() {
            log("AI Ready!");
            modelIsReady = true;
            document.getElementById('loading-msg').classList.add('hidden');
            document.getElementById('start-btn').classList.remove('hidden');
        }

        function startGameSystem() {
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            gameState = 'COUNTDOWN'; countdownVal = 3;
            document.getElementById('charge-bar-container').style.display = 'block';
        }

        function returnToTitleSystem() { 
            gameState = 'TITLE'; 
            stopAllSounds();
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
            document.getElementById('title-screen').style.display = 'flex'; 
            document.getElementById('charge-bar-container').style.display = 'none';
            document.getElementById('init-btn').classList.add('hidden');
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('loading-msg').classList.add('hidden');
        }

        // ■■■ P5.js ■■■
        function setup() {
            log("P5 Setup");
            let c = createCanvas(windowWidth, windowHeight);
            c.style('display', 'block');
            colorMode(RGB, 255, 255, 255, 255);
            background(0);

            loadResources();

            let savedScore = localStorage.getItem('kamehameha_highscore');
            if(savedScore) highScore = parseInt(savedScore);
            updateScoreLabels();
            
            bossBaseY = height * 0.6;
        }

        function loadResources() {
            imgWater = loadImage('water.png', ()=>{}, ()=>{ log("Err:water"); });
            imgEnemy1 = loadImage('enemy1.png', ()=>{}, ()=>{ log("Err:enm1"); });
            imgEnemy2 = loadImage('enemy2.png', ()=>{}, ()=>{ log("Err:enm2"); });
            imgBoss = loadImage('boss.png', ()=>{}, ()=>{ log("Err:boss"); });
            imgBossEnd = loadImage('boss_end.png', ()=>{}, ()=>{ log("Err:boss_e"); });
            
            bgmNormal = loadSound('normal_bgm.mp3', ()=>{}, ()=>{ log("Err:bgm_n"); });
            bgmExtra1 = loadSound('extra1_bgm.mp3', ()=>{}, ()=>{ log("Err:bgm_ex"); });
            bgmBoss = loadSound('boss_bgm.mp3', ()=>{}, ()=>{ log("Err:bgm_b"); });
            bgmVictory = loadSound('victory.mp3', ()=>{}, ()=>{ log("Err:bgm_v"); });
        }

        function setupSounds() {
            osc = new p5.Oscillator('sine');
            osc.amp(0); osc.start();
            noiseOsc = new p5.Noise('brown');
            noiseOsc.amp(0); noiseOsc.start();
        }

        function stopAllSounds() {
            if(bgmNormal && bgmNormal.isPlaying()) bgmNormal.stop();
            if(bgmExtra1 && bgmExtra1.isPlaying()) bgmExtra1.stop();
            if(bgmBoss && bgmBoss.isPlaying()) bgmBoss.stop();
            if(bgmVictory && bgmVictory.isPlaying()) bgmVictory.stop();
        }

        function updateScoreLabels() {
            let elT = document.getElementById('high-score-title');
            let elR = document.getElementById('high-score-result');
            if(elT) elT.innerText = formatScore(highScore);
            if(elR) elR.innerText = formatScore(highScore);
        }

        function formatScore(n) {
            return n.toLocaleString();
        }

        function draw() {
            background(0);
            
            if (video && video.width) {
                let scaleW = width / video.width;
                let scaleH = height / video.height;
                vScale = max(scaleW, scaleH);
                let renderW = video.width * vScale;
                let renderH = video.height * vScale;
                videoX = (width - renderW) / 2;
                videoY = (height - renderH) / 2;

                push();
                translate(width, 0);
                scale(-1, 1);
                image(video, -(videoX + renderW), videoY, renderW, renderH); 
                pop();
                
                fill(0, 150); 
                noStroke();
                rect(0, 0, width, height);
            }

            if (gameState === 'INIT' || gameState === 'LOADING' || gameState === 'TITLE') {
                updatePoseTracking();
                drawSkeletonDebug();
            } else if (gameState === 'GAME' || gameState === 'EXTRA1' || gameState === 'EXTRA2') {
                updatePoseTracking(); 
                updateGameLogic();    
                drawGameObjects();
                drawGameUI(); 
                drawSkeletonDebug();
            } else if (gameState === 'WARNING') {
                updatePoseTracking(); 
                drawWarning();
            } else if (gameState === 'COUNTDOWN') {
                updatePoseTracking(); 
                drawCountdown();
            }
        }

        function updatePoseTracking() {
            trackedPos = [null, null];
            if (poses.length > 0) {
                let pose = poses[0].pose;
                if (pose.leftWrist.confidence > 0.1) trackedPos[0] = transform