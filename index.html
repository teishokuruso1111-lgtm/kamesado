<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>かめはめ波（Native Camera）</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; color: white; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        
        button { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            border: 3px solid #FFF; padding: 15px 50px; font-size: 24px; font-weight: 900; 
            color: #333; border-radius: 50px; cursor: pointer; margin: 15px; pointer-events: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        button:active { transform: scale(0.95); }

        .screen { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 30px; 
            border: 4px solid #00FF00; box-shadow: 0 0 30px #00FF00; margin-top: 10%; pointer-events: auto;
            width: 90%; max-width: 600px;
        }
        .hidden { display: none !important; }
        
        h1 { color: #00FF00; font-size: 40px; margin: 0 0 20px 0; text-shadow: 0 0 10px white; font-weight: 900; text-align: center; }
        #status-msg { color: #00FF00; font-size: 18px; font-weight: bold; margin-top: 20px; text-align: center; }
        
        #debug-info { position: absolute; top: 0; left: 0; color: red; font-size: 12px; z-index: 20; background: rgba(0,0,0,0.5); }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
</head>
<body>
    <div id="debug-info">System Ready</div>

    <div id="ui-layer">
        <div id="title-screen" class="screen">
            <h1>かめはめ波</h1>
            <p>〜 カメラ修正版 〜</p>
            <p>High Score: <span id="high-score">0</span></p>
            
            <button onclick="startApp()" id="init-btn">カメラ起動</button>
            <button onclick="gameStart()" id="start-btn" class="hidden">あそぶ！</button>
            
            <div id="status-msg">ボタンを押してね</div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h1 id="result-title">おしまい！</h1>
            <h2 id="final-score" style="color:cyan; font-size:40px;">0</h2>
            <button onclick="resetGame()">タイトルへ</button>
        </div>
        
        <div id="bar-box" style="position:absolute; bottom:20px; width:80%; height:30px; border:2px solid white; border-radius:15px; display:none;">
            <div id="bar" style="width:0%; height:100%; background:orange;"></div>
        </div>
    </div>

    <script>
        // 画像アスペクト比 (676:369)
        const IMG_RATIO = 369 / 676; 

        // --- 変数 ---
        let video;
        let poseNet;
        let poses = [];
        let trackedPos = [null, null];
        
        let imgWater, imgEnemy1, imgEnemy2, imgBoss, imgBossEnd;
        let audioBGM = new Audio('normal_bgm.mp3'); audioBGM.loop = true;
        let audioExtra = new Audio('extra1_bgm.mp3'); audioExtra.loop = true;
        let audioBoss = new Audio('boss_bgm.mp3'); audioBoss.loop = true;
        let audioWin = new Audio('victory.mp3');
        
        let balloons = [];
        let score = 0;
        let highScore = 0;
        let gameState = 'INIT'; 
        let isCharging=false, isFiring=false, chargeTimer=0, fireTimer=0;
        let extraTimer=0, boss=null, bossIsDead=false, needsSeparation=false;
        let waterSpawned = false, hasCollectedWater = false;
        let timeLeft = 60;

        function debug(msg) {
            document.getElementById('debug-info').innerText = msg;
            console.log(msg);
        }

        // ★★★ ボタンアクション ★★★
        function startApp() {
            document.getElementById('init-btn').classList.add('hidden');
            document.getElementById('status-msg').innerText = "カメラ準備中...";
            
            // ★修正：サイズ指定を削除（自動設定に任せる）
            let constraints = {
                video: true, // とにかくカメラを使う
                audio: false
            };
            
            if (location.hostname.includes("github.io")) {
                // GitHub上ならインカメラを優先（解像度は指定しない）
                constraints.video = {
                    facingMode: "user"
                };
            }

            video = createCapture(constraints, function(stream) {
                debug("Camera Loaded! Size: " + video.width + "x" + video.height);
                document.getElementById('status-msg').innerText = "AI読み込み中...";
                initAI();
            });
            
            video.hide();
            
            // iPad対策
            if(video.elt) {
                video.elt.setAttribute('playsinline', '');
                video.elt.setAttribute('autoplay', '');
            }
        }

        function initAI() {
            let options = {
                architecture: 'MobileNetV1', 
                imageScaleFactor: 0.3, 
                outputStride: 16, 
                flipHorizontal: true, 
                minConfidence: 0.5, 
                detectionType: 'single'
            };
            poseNet = ml5.poseNet(video, options, () => {
                debug("AI Ready");
                document.getElementById('status-msg').innerText = "準備完了！";
                document.getElementById('start-btn').classList.remove('hidden');
            });
            poseNet.on('pose', (results) => { poses = results; });
        }

        function gameStart() {
            gameState = 'PLAY';
            score = 0;
            balloons = [];
            timeLeft = 60;
            hasCollectedWater = false; waterSpawned = false; bossIsDead = false;
            
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('bar-box').style.display = 'block';
            
            stopAllSounds();
            audioBGM.currentTime = 0;
            audioBGM.play().catch(e => console.log("Audio Error: " + e));
        }

        function resetGame() {
            gameState = 'READY';
            stopAllSounds();
            
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
            document.getElementById('bar-box').style.display = 'none';
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('init-btn').classList.add('hidden');
            document.getElementById('status-msg').innerText = "いつでもOK";
            
            boss = null;
            balloons = [];
        }

        function stopAllSounds() {
            audioBGM.pause(); audioExtra.pause(); audioBoss.pause(); audioWin.pause();
        }

        function endGame() {
            gameState = 'RESULT';
            stopAllSounds();
            
            let title = bossIsDead ? "完全クリア！" : "タイムアップ";
            document.getElementById('result-title').innerText = title;
            document.getElementById('final-score').innerText = score.toLocaleString();
            
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('bar-box').style.display = 'none';
            
            if(score > highScore) {
                highScore = score;
                localStorage.setItem('kamehameha_highscore', highScore);
                document.getElementById('high-score').innerText = highScore;
            }
        }

        // --- p5.js ---

        function setup() {
            createCanvas(windowWidth, windowHeight);
            
            imgWater = loadImage('water.png');
            imgEnemy1 = loadImage('enemy1.png');
            imgEnemy2 = loadImage('enemy2.png');
            imgBoss = loadImage('boss.png');
            imgBossEnd = loadImage('boss_end.png');

            let s = localStorage.getItem('kamehame