<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>かめはめ波（Absolute Start）</title>
    <style>
        body { margin: 0; padding: 0; background: #222; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; color: white; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        
        button { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            border: 3px solid #FFF; padding: 15px 50px; font-size: 24px; font-weight: 900; 
            color: #333; border-radius: 50px; cursor: pointer; margin: 15px; pointer-events: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        button:active { transform: scale(0.95); }

        .screen { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 30px; 
            border: 4px solid #00FF00; box-shadow: 0 0 30px #00FF00; margin-top: 10%; pointer-events: auto;
            width: 90%; max-width: 600px;
        }
        .hidden { display: none !important; }
        
        h1 { color: #00FF00; font-size: 40px; margin: 0 0 20px 0; text-shadow: 0 0 10px white; font-weight: 900; text-align: center; }
        #status-msg { color: #00FF00; font-size: 18px; font-weight: bold; margin-top: 20px; text-align: center; }
        
        /* 動作確認用の赤い丸（Canvasの下に敷く） */
        #bg-check { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #444; z-index: -1; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
</head>
<body>
    <div id="bg-check">System Loading...</div>

    <div id="ui-layer">
        <div id="title-screen" class="screen">
            <h1>かめはめ波</h1>
            <p>〜 最終起動版 〜</p>
            <p>High Score: <span id="high-score">0</span></p>
            
            <button onclick="startApp()" id="init-btn">カメラ起動</button>
            <button onclick="gameStart()" id="start-btn" class="hidden">あそぶ！</button>
            
            <div id="status-msg">ボタンを押してね</div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h1>おしまい！</h1>
            <h2 id="final-score" style="color:cyan; font-size:40px;">0</h2>
            <button onclick="resetGame()">タイトルへ</button>
        </div>
        
        <div id="bar-box" style="position:absolute; bottom:20px; width:80%; height:30px; border:2px solid white; border-radius:15px; display:none;">
            <div id="bar" style="width:0%; height:100%; background:orange;"></div>
        </div>
    </div>

    <script>
        // --- 変数 ---
        let video;
        let poseNet;
        let poses = [];
        let trackedPos = [null, null];
        
        // 画像・音
        let imgWater, imgEnemy1, imgEnemy2, imgBoss, imgBossEnd;
        let bgmNormal, bgmExtra1, bgmBoss, bgmVictory;
        
        // ゲーム
        let balloons = [];
        let score = 0;
        let highScore = 0;
        let gameState = 'INIT'; // INIT, LOADING, READY, PLAY, RESULT
        let isCharging=false, isFiring=false, chargeTimer=0, fireTimer=0;
        let extraTimer=0, boss=null, bossIsDead=false;
        let needsSeparation=false;

        // ★★★ ボタンアクション ★★★
        function startApp() {
            // アラートで動作確認（これで動かなければHTMLがおかしい）
            // alert("カメラを起動します。許可してください。"); 
            
            document.getElementById('init-btn').classList.add('hidden');
            document.getElementById('status-msg').innerText = "カメラ準備中...";
            
            // 音声コンテキスト起動
            userStartAudio();

            // カメラ設定
            let constraints = {
                video: { width: 640, height: 480 },
                audio: false
            };
            if (location.hostname.includes("github.io")) {
                constraints.video.facingMode = "user";
            }

            video = createCapture(constraints, function() {
                console.log("Camera OK");
                document.getElementById('status-msg').innerText = "AI読み込み中...";
                initAI();
            });
            video.size(640, 480);
            video.hide();
            
            // iPad対策
            if(video.elt) video.elt.setAttribute('playsinline', '');
        }

        function initAI() {
            let options = {
                architecture: 'MobileNetV1', 
                imageScaleFactor: 0.3, 
                outputStride: 16, 
                flipHorizontal: true, 
                minConfidence: 0.5, 
                detectionType: 'single'
            };
            poseNet = ml5.poseNet(video, options, () => {
                console.log("AI Ready");
                document.getElementById('status-msg').innerText = "準備完了！";
                document.getElementById('start-btn').classList.remove('hidden');
            });
            poseNet.on('pose', (results) => { poses = results; });
        }

        function gameStart() {
            gameState = 'PLAY';
            score = 0;
            balloons = [];
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('bar-box').style.display = 'block';
            
            if(bgmNormal && bgmNormal.isLoaded()) {
                bgmNormal.setVolume(0.5); bgmNormal.loop();
            }
        }

        function resetGame() {
            gameState = 'READY';
            stopAllSounds();
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
            document.getElementById('bar-box').style.display = 'none';
            document.getElementById('init-btn').classList.add('hidden'); // カメラはもう動いている
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('status-msg').innerText = "いつでもOK";
        }

        // --- p5.js 標準関数 ---

        function setup() {
            createCanvas(windowWidth, windowHeight);
            
            // リソース読み込み（エラー無視）
            imgWater = loadImage('water.png');
            imgEnemy1 = loadImage('enemy1.png');
            imgEnemy2 = loadImage('enemy2.png');
            imgBoss = loadImage('boss.png');
            imgBossEnd = loadImage('boss_end.png');
            
            bgmNormal = loadSound('normal_bgm.mp3');
            bgmExtra1 = loadSound('extra1_bgm.mp3');
            bgmBoss = loadSound('boss_bgm.mp3');
            bgmVictory = loadSound('victory.mp3');

            let s = localStorage.getItem('kamehameha_highscore');
            if(s) highScore = parseInt(s);
            document.getElementById('high-score').innerText = highScore;
        }

        function draw() {
            background(50); // 背景グレー

            // 1. カメラ描画
            if (video && video.width) {
                push();
                translate(width, 0);
                scale(-1, 1);
                // 画面いっぱいに表示
                let scale = max(width/video.width, height/video.height);
                let w = video.width * scale;
                let h = video.height * scale;
                let x = (width - w) / 2;
                let y = (height - h) / 2;
                image(video, -(x+w), y, w, h);
                pop();
                
                // 暗くする
                fill(0, 100); noStroke(); rect(0,0,width,height);
            } else {
                // カメラがない時の表示
                fill(255, 0, 0); textAlign(CENTER); textSize(20);
                text("Waiting for Camera...", width/2, height/2);
            }

            // 2. AI更新
            updatePose();

            // 3. ゲーム処理
            if (gameState === 'PLAY' || gameState === 'EXTRA') {
                updateGame();
                drawGame();
            } else {
                // タイトルでも手を表示（動作確認）
                drawHands();
            }
        }

        function updatePose() {
            trackedPos = [null, null];
            if (poses.length > 0) {
                let p = poses[0].pose;
                if (p.leftWrist.confidence > 0.1) trackedPos[0] = transform(p.leftWrist.x, p.leftWrist.y);
                if (p.rightWrist.confidence > 0.1) trackedPos[1] = transform(p.rightWrist.x, p.rightWrist.y);
            }
        }

        function transform(x, y) {
            if(!video) return {x:0, y:0};
            let scale = max(width/video.width, height/video.height);
            let w = video.width * scale;
            let h = video.height * scale;
            let vx = (width - w) / 2;
            let vy = (height - h) / 2;
            let sx = vx + (video.width - x) * scale; // 左右反転
            let sy = vy + y * scale;
            return { x: sx, y: sy };
        }

        function drawHands() {
            noFill(); strokeWeight(5);
            if (trackedPos[0]) { stroke(0,255,255); circle(trackedPos[0].x, trackedPos[0].y, 50); }
            if (trackedPos[1]) { stroke(255,50,50); circle(trackedPos[1].x, trackedPos[1].y, 50); }
        }

        function updateGame() {
            // 敵出現
            if (frameCount % 60 === 0 && gameState === 'PLAY') {
                balloons.push({ x: random(50, width-50), y: height+50, r: 40, speed: 3, type: 'NORMAL' });
            }

            // チャージ
            if (trackedPos[0] && trackedPos[1]) {
                let d = dist(trackedPos[0].x, trackedPos[0].y, trackedPos[1].x, trackedPos[1].y);
                if (needsSeparation) {
                    if(d > 200) needsSeparation = false;
                } else if (d < 150) {
                    isCharging = true;
                    chargeTimer += 2;
                    if(chargeTimer > 100) {
                        isFiring = true; chargeTimer = 0; fireTimer = 30;
                        isCharging = false;
                    }
                } else {
                    chargeTimer = 0; isCharging = false;
                }
            }

            if(isFiring) {
                fireTimer--;
                if(fireTimer <= 0) { isFiring = false; needsSeparation = true; }
            }

            // 当たり判定
            for (let i = balloons.length - 1; i >= 0; i--) {
                let b = balloons[i];
                b.y -= b.speed;
                let hit = false;
                if(isFiring) hit = true; // ビーム中は最強
                else {
                    if(trackedPos[0] && dist(trackedPos[0].x, trackedPos[0].y, b.x, b.y) < b.r + 30) hit = true;
                    if(trackedPos[1] && dist(trackedPos[1].x, trackedPos[1].y, b.x, b.y) < b.r + 30) hit = true;
                }

                if(hit) {
                    score += 10;
                    balloons.splice(i, 1);
                } else if(b.y < -50) {
                    balloons.splice(i, 1);
                }
            }
            
            // UI更新
            let bar = document.getElementById('bar');
            if(needsSeparation) { bar.style.width='100%'; bar.style.background='blue'; }
            else if(isCharging) { bar.style.width=chargeTimer+'%'; bar.style.background='orange'; }
            else { bar.style.width='0%'; }
        }

        function drawGame() {
            // 敵
            for (let b of balloons) {
                if(imgEnemy1 && imgEnemy1.width > 1) {
                    imageMode(CENTER); image(imgEnemy1, b.x, b.y, b.r*2, b.r*2);
                } else {
                    fill(255,0,0); noStroke(); circle(b.x, b.y, b.r*2);
                }
            }
            // ビーム
            if(isFiring) {
                fill(255,255,0,150); noStroke(); rect(0,0,width,height);
            }
            // 手
            drawHands();
            
            // スコア
            fill(255); textSize(30); textAlign(LEFT, TOP);
            text("SCORE: " + score, 20, 20);
        }

        function stopAllSounds() {
            if(bgmNormal) bgmNormal.stop();
            if