<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>かめはめ波（Dark Mode Fix）</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        
        button { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            border: 3px solid #FFF; padding: 15px 50px; font-size: clamp(20px, 5vw, 30px); font-weight: 900; 
            color: #333; border-radius: 50px; cursor: pointer; margin: 15px; pointer-events: auto; transition: transform 0.1s; box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        button:active { transform: scale(0.95); }

        .screen { 
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 30px; 
            border: 4px solid #00FF00; box-shadow: 0 0 30px #00FF00; margin-top: 5%; pointer-events: auto;
            width: 90%; max-width: 600px; box-sizing: border-box;
        }
        
        h1 { color: #00FF00; font-size: clamp(40px, 10vw, 80px); margin: 0 0 20px 0; text-shadow: 0 0 15px white; font-weight: 900; letter-spacing: 5px; text-align: center; }
        p { color: white; font-size: clamp(16px, 4vw, 24px); margin-bottom: 30px; font-weight: bold; text-align: center; line-height: 1.5; }
        
        .score-val { font-size: clamp(40px, 10vw, 80px); color: #00FFFF; font-weight: 900; text-shadow: 0 0 20px #00FFFF; margin-bottom: 30px; }

        #charge-bar-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; height: 30px; background: rgba(255, 255, 255, 0.2); border-radius: 15px; overflow: hidden; display: none; border: 3px solid white; }
        #charge-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #FFFF00, #FF4500); transition: width 0.1s; }
        
        .credit { margin-top: 20px; font-size: 12px; color: #AAA; text-align: center; }
        #loading-msg { color: #00FF00; font-size: 20px; font-weight: bold; margin-top: 20px; display: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
</head>
<body>
    <div id="ui-layer">
        <div id="title-screen" class="screen">
            <h1>かめはめ波</h1>
            <p>〜 AI モーションキャプチャ版 〜</p>
            <p style="color:#FFFF00">ハイスコア: <span id="high-score-title">0</span></p>
            <button onclick="startGame()" id="start-btn">ロード中...</button>
            <div id="loading-msg">AI準備中...<br>初回は時間がかかります</div>
            <div class="credit">音楽素材：魔王魂 / AR Spark</div>
        </div>

        <div id="result-screen" class="screen">
            <h1>おしまい！</h1>
            <div style="font-size: 20px; color:#AAA;">今回のスコア</div>
            <div class="score-val"><span id="final-score">0</span></div>
            <p style="color:#FFFF00">ハイスコア: <span id="high-score-result">0</span></p>
            <button onclick="returnToTitle()">タイトルへ</button>
        </div>
        <div id="charge-bar-container"><div id="charge-bar"></div></div>
    </div>

    <script>
        // 解像度設定 (高画質)
        const CAM_W = 800; 
        const CAM_H = 600;
        
        let poseNet;
        let poses = [];
        let video;
        let vScale = 1.0; 
        let videoX = 0, videoY = 0;

        let imgWater, imgEnemy1, imgEnemy2, imgBoss, imgBossEnd;
        let bgmNormal, bgmExtra1, bgmBoss, bgmVictory; 
        
        let imagesLoaded = { water: false, enemy1: false, enemy2: false, boss: false, bossEnd: false };
        let soundLoaded = { normal: false, extra1: false, boss: false, victory: false };

        let balloons = [];
        let floatingTexts = []; 
        let score = 0;
        let highScore = 0;
        let timeLeft = 60;
        let gameState = 'LOADING'; 
        let trackedPos = [null, null]; 
        
        let chargeTimer = 0;
        let isCharging = false;
        let isFiring = false;
        let fireTimer = 0;
        let cooldownTimer = 0;
        let needsSeparation = false; 
        let osc, noiseOsc;

        let hasCollectedWater = false;
        let waterSpawned = false;
        let warningTextX = 0;
        let extraTimer = 0;
        let boss = null;
        let bossBaseY = 0; 
        let bossIsDead = false;
        let modelIsReady = false;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            colorMode(RGB, 255, 255, 255, 255);
            background(0);

            loadResources();

            let savedScore = localStorage.getItem('kamehameha_highscore');
            if(savedScore) highScore = parseInt(savedScore);
            updateScoreLabels();
            
            let constraints = {
                video: {
                    facingMode: (location.hostname.includes("github.io")) ? "user" : undefined,
                    width: { ideal: CAM_W },
                    height: { ideal: CAM_H }
                },
                audio: false
            };
            video = createCapture(constraints, function() { 
                console.log("Camera OK"); 
                initPoseNet();
            });
            video.size(CAM_W, CAM_H);
            video.hide();
            
            setupSounds();
            bossBaseY = height * 0.6;
        }

        function initPoseNet() {
            document.getElementById('loading-msg').style.display = 'block';
            let options = {
                architecture: 'MobileNetV1',
                imageScaleFactor: 0.3,
                outputStride: 16,
                flipHorizontal: true,
                minConfidence: 0.5,
                maxPoseDetects: 1,
                scoreThreshold: 0.5,
                nmsRadius: 20,
                detectionType: 'single',
                multiplier: 0.75
            };
            poseNet = ml5.poseNet(video, options, modelReady);
            poseNet.on('pose', function(results) {
                poses = results;
            });
        }

        function modelReady() {
            console.log('Model Loaded');
            modelIsReady = true;
            document.getElementById('start-btn').innerText = "あそぶ！";
            document.getElementById('loading-msg').style.display = 'none';
        }

        function loadResources() {
            imgWater = loadImage('water.png', () => imagesLoaded.water = true, () => console.log('water error'));
            imgEnemy1 = loadImage('enemy1.png', () => imagesLoaded.enemy1 = true, () => console.log('enemy1 error'));
            imgEnemy2 = loadImage('enemy2.png', () => imagesLoaded.enemy2 = true, () => console.log('enemy2 error'));
            imgBoss = loadImage('boss.png', () => imagesLoaded.boss = true, () => console.log('boss error'));
            imgBossEnd = loadImage('boss_end.png', () => imagesLoaded.bossEnd = true, () => console.log('boss_end error'));
            
            bgmNormal = loadSound('normal_bgm.mp3', () => soundLoaded.normal = true, () => console.log('bgm error'));
            bgmExtra1 = loadSound('extra1_bgm.mp3', () => soundLoaded.extra1 = true, () => console.log('bgm error'));
            bgmBoss = loadSound('boss_bgm.mp3', () => soundLoaded.boss = true, () => console.log('bgm error'));
            bgmVictory = loadSound('victory.mp3', () => soundLoaded.victory = true, () => console.log('bgm error'));
        }

        function setupSounds() {
            osc = new p5.Oscillator('sine');
            osc.amp(0); osc.start();
            noiseOsc = new p5.Noise('brown');
            noiseOsc.amp(0); noiseOsc.start();
        }

        function ensureAudio() {
            if (getAudioContext().state !== 'running') {
                getAudioContext().resume();
            }
        }

        function updateScoreLabels() {
            document.getElementById('high-score-title').innerText = formatScore(highScore);
            document.getElementById('high-score-result').innerText = formatScore(highScore);
        }

        function formatScore(n) {
            return n.toLocaleString();
        }

        function draw() {
            background(0);
            
            if (video && video.width) {
                let scaleW = width / video.width;
                let scaleH = height / video.height;
                vScale = max(scaleW, scaleH);
                let renderW = video.width * vScale;
                let renderH = video.height * vScale;
                videoX = (width - renderW) / 2;
                videoY = (height - renderH) / 2;

                push();
                translate(width, 0);
                scale(-1, 1);
                // ★修正：映像を暗くする (tint)
                tint(255, 100); // 100/255 の透明度（暗く表示）
                image(video, -(videoX + renderW), videoY, renderW, renderH); 
                pop();
            }

            if (gameState === 'LOADING') {
                gameState = 'TITLE';
                document.getElementById('title-screen').style.display = 'flex';
            }

            if (gameState === 'GAME' || gameState === 'EXTRA1' || gameState === 'EXTRA2') {
                updatePoseTracking(); 
                updateGameLogic();    
                drawGameObjects();
                drawGameUI(); 
                drawSkeletonDebug();
            } else if (gameState === 'WARNING') {
                updatePoseTracking(); 
                drawWarning();
            } else if (gameState === 'COUNTDOWN') {
                updatePoseTracking(); 
                drawCountdown();
            } else if (gameState === 'TITLE') {
                updatePoseTracking();
                drawSkeletonDebug();
            }
        }

        function updatePoseTracking() {
            trackedPos = [null, null];
            if (poses.length > 0) {
                let pose = poses[0].pose;
                if (pose.leftWrist.confidence > 0.2) trackedPos[0] = transformCoords(pose.leftWrist.x, pose.leftWrist.y);
                if (pose.rightWrist.confidence > 0.2) trackedPos[1] = transformCoords(pose.rightWrist.x, pose.rightWrist.y);
            }
        }

        function transformCoords(x, y) {
            let screenX = map(x, 0, video.width, width, 0); 
            let screenY = map(y, 0, video.height, 0, height);
            return { x: screenX, y: screenY };
        }

        function drawSkeletonDebug() {
            // 手の位置にマーカーを表示（左：青緑、右：赤）
            noFill(); strokeWeight(5);
            if (trackedPos[0]) { stroke(0, 255, 200); circle(trackedPos[0].x, trackedPos[0].y, 50); }
            if (trackedPos[1]) { stroke(255, 50, 50); circle(trackedPos[1].x, trackedPos[1].y, 50); }
        }

        function updateGameLogic() {
            if (frameCount % 60 === 0) {
                if (gameState === 'GAME' && timeLeft > 0) timeLeft--;
                if ((gameState === 'EXTRA1' || gameState === 'EXTRA2') && extraTimer > 0) extraTimer--;
            }

            if (gameState === 'GAME') {
                if (timeLeft <= 20 && !waterSpawned && !hasCollectedWater) {
                    spawnWater();
                    waterSpawned = true;
                }
                if (timeLeft <= 0) {
                    if (hasCollectedWater) {
                        gameState = 'WARNING';
                        warningTextX = width;
                        if(soundLoaded.normal && bgmNormal.isPlaying()) bgmNormal.stop();
                    } else {
                        // ★修正：深層水なしの場合も確実に終了処理へ
                        endGame();
                    }
                }
            } else if (gameState === 'EXTRA1') {
                if (extraTimer <= 0) {
                    startExtraStage2();
                }
            } else if (gameState === 'EXTRA2') {
                if (bossIsDead && extraTimer <= 0) endGame();
                else if (!bossIsDead && extraTimer <= 0) endGame(); // 倒せず終了
            }

            handleKamehameha();
            updateBalloons();
            updateFloatingTexts();
            if (gameState === 'EXTRA2') updateBoss();
        }

        function spawnWater() {
            balloons.push({
                type: 'WATER',
                x: random(100, width-100),
                y: height + 50,
                r: min(width, height) * 0.1, 
                speed: 4,
                c: color(0, 100, 255)
            });
        }

        function startExtraStage1() {
            gameState = 'EXTRA1';
            balloons = [];
            extraTimer = 15;
            score += 0; 
            if (soundLoaded.extra1 && bgmExtra1.isLoaded()) {
                bgmExtra1.setVolume(0.5);
                bgmExtra1.loop();
            }
        }

        function startExtraStage2() {
            gameState = 'EXTRA2';
            balloons = [];
            extraTimer = 15;
            boss = { x: width/2, y: bossBaseY, w: min(width, height)*0.5, h: min(width, height)*0.5, hp: 2, justHit: false };
            bossIsDead = false;
            
            if (soundLoaded.extra1 && bgmExtra1.isPlaying()) bgmExtra1.stop();
            if (soundLoaded.boss && bgmBoss.isLoaded()) {
                bgmBoss.setVolume(0.5);
                bgmBoss.loop();
            }
        }

        function updateBalloons() {
            if (!isFiring && gameState !== 'EXTRA2' && frameCount % 30 === 0) {
                spawnBalloon();
            }

            for (let i = balloons.length - 1; i >= 0; i--) {
                let b = balloons[i];
                b.y -= b.speed;
                let hit = false;
                if (!isFiring) {
                    for (let p of trackedPos) {
                        if (p && dist(p.x, p.y, b.x, b.y) < b.r + 80) hit = true; 
                    }
                }
                if (hit) { popBalloon(i); } 
                else if (b.y < -b.r) { balloons.splice(i, 1); }
            }
        }

        function spawnBalloon() {
            let sizeBase = min(width, height) * 0.1;
            if (gameState === 'GAME') {
                balloons.push({ type: 'NORMAL', x: random(50, width-50), y: height+50, r: sizeBase, c: color(random(255), random(255), random(255)), speed: random(3, 7) });
            } else if (gameState === 'EXTRA1') {
                let type = random() < 0.5 ? 'GASHIMA' : 'IGONERI';
                balloons.push({ type: type, x: random(50, width-50), y: height+50, r: sizeBase, c: color(255), speed: random(6, 10) });
            }
        }

        function popBalloon(i) {
            let b = balloons[i];
            let pts = 0;
            if (b.type === 'NORMAL') pts = 1;
            else if (b.type === 'WATER') {
                pts = 332;
                hasCollectedWater = true;
                addFloatingText("332", b.x, b.y, 60); 
            }
            else if (b.type === 'GASHIMA' || b.type === 'IGONERI') {
                pts = 15;
                addFloatingText("15", b.x, b.y, 40); 
            }
            score += pts;
            balloons.splice(i, 1);
            osc.freq(random(500, 1000));
            osc.amp(0.3, 0.05); setTimeout(()=>osc.amp(0, 0.05), 100);
        }

        function updateBoss() {
            if (!boss || bossIsDead) return;
            boss.y = bossBaseY + sin(frameCount * 0.05) * 20;

            if (isFiring) {
                if (!boss.justHit) {
                    boss.hp--; 
                    boss.justHit = true; 
                    if (boss.hp <= 0) {
                        score += 31000000000;
                        bossIsDead = true;
                        extraTimer = 3; 
                        noiseOsc.amp(1.0, 0.1); setTimeout(()=>noiseOsc.amp(0, 1.0), 1000);
                        if (soundLoaded.boss && bgmBoss.isPlaying()) bgmBoss.stop();
                        if (soundLoaded.victory && bgmVictory.isLoaded()) { bgmVictory.setVolume(1.0); bgmVictory.play(); }
                        addFloatingText("310億", width/2, height/2, 180); 
                    } else {
                        addFloatingText("あと1回！", width/2, boss.y, 60);
                        osc.freq(100); osc.amp(0.8, 0.05); setTimeout(()=>osc.amp(0, 0.05), 200);
                    }
                }
            } else {
                boss.justHit = false;
            }
        }

        function drawGameObjects() {
            for (let b of balloons) {
                push();
                translate(b.x, b.y);
                let drawSize = b.r * 2.5;
                if (b.type === 'WATER') drawImageOrShape(imgWater, imagesLoaded.water, "佐渡海洋深層水", drawSize, color(0,100,255));
                else if (b.type === 'GASHIMA') drawImageOrShape(imgEnemy1, imagesLoaded.enemy1, "ガシマ", drawSize, color(255,0,0));
                else if (b.type === 'IGONERI') drawImageOrShape(imgEnemy2, imagesLoaded.enemy2, "いごねり", drawSize, color(0,255,0));
                else {
                    fill(b.c); stroke(255); strokeWeight(3); circle(0, 0, b.r * 2);
                    noStroke(); fill(255, 100); circle(-b.r/3, -b.r/3, b.r/2);
                }
                pop();
            }

            if (gameState === 'EXTRA2' && boss) {
                push();
                translate(boss.x, boss.y);
                let displayImg = bossIsDead ? imgBossEnd : imgBoss;
                let loaded = bossIsDead ? imagesLoaded.bossEnd : imagesLoaded.boss;
                let label = bossIsDead ? "撃破！" : "佐渡ヶ島(Boss)";
                drawImageOrShape(displayImg, loaded, label, (boss.w) * 2, color(100));
                pop();
            }

            if (isFiring) drawBeam();

            for (let ft of floatingTexts) {
                push();
                textAlign(CENTER, CENTER); textStyle(BOLD);