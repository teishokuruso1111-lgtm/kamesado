<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>かめはめ波（Visual Debug）</title>
    <style>
        /* 背景を真っ黒ではなく、濃いグレーにする（動作確認用） */
        body { margin: 0; padding: 0; background: #333; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; color: white; }
        
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        
        button { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            border: 3px solid #FFF; padding: 15px 50px; font-size: clamp(20px, 5vw, 30px); font-weight: 900; 
            color: #333; border-radius: 50px; cursor: pointer; margin: 15px; pointer-events: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: auto;
        }
        button:active { transform: scale(0.95); }

        .screen { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 30px; 
            border: 4px solid #00FF00; box-shadow: 0 0 30px #00FF00; margin-top: 10%; 
            width: 90%; max-width: 600px; box-sizing: border-box; pointer-events: auto;
        }
        .hidden { display: none !important; }
        
        h1 { color: #00FF00; font-size: clamp(40px, 10vw, 80px); margin: 0 0 20px 0; text-shadow: 0 0 15px white; font-weight: 900; letter-spacing: 5px; text-align: center; }
        .score-val { font-size: clamp(40px, 10vw, 80px); color: #00FFFF; font-weight: 900; text-shadow: 0 0 20px #00FFFF; margin-bottom: 30px; }
        
        /* 画面左上のデバッグ表示 */
        #status-display {
            position: absolute; top: 0; left: 0; padding: 10px;
            background: rgba(0,0,0,0.5); font-size: 14px; color: lime;
            text-align: left; z-index: 20; pointer-events: none;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
</head>
<body>
    <div id="status-display">System Init...</div>

    <div id="ui-layer">
        <div id="title-screen" class="screen">
            <h1>かめはめ波</h1>
            <p>〜 最終デバッグ版 〜</p>
            <p>High Score: <span id="high-score-title">0</span></p>
            
            <button id="init-btn">カメラ起動</button>
            <button id="start-btn" class="hidden">あそぶ！</button>
            
            <div id="loading-msg" class="hidden">準備中...</div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h1>おしまい！</h1>
            <div class="score-val"><span id="final-score">0</span></div>
            <button id="return-btn">タイトルへ</button>
        </div>
    </div>

    <script>
        // デバッグ表示更新関数
        function updateStatus(msg) {
            let el = document.getElementById('status-display');
            if(el) el.innerHTML = msg;
            console.log(msg);
        }

        // 変数定義
        let video;
        let poseNet;
        let poses = [];
        let trackedPos = [null, null];

        // 画像・音楽
        let imgWater, imgEnemy1, imgEnemy2, imgBoss, imgBossEnd;
        let bgmNormal, bgmExtra1, bgmBoss, bgmVictory;
        
        // ゲーム状態
        let balloons = [];
        let score = 0;
        let highScore = 0;
        let gameState = 'INIT';
        let chargeTimer = 0, isCharging = false, isFiring = false, fireTimer = 0;
        let extraTimer = 0, boss = null, bossIsDead = false;
        let needsSeparation = false;
        
        // 音（オシレーター）
        let osc, noiseOsc;

        // ★★★ 起動処理 ★★★
        window.onload = function() {
            updateStatus("Window Loaded. Waiting for button...");
            document.getElementById('init-btn').onclick = startSystem;
            document.getElementById('start-btn').onclick = gameStart;
            document.getElementById('return-btn').onclick = returnTitle;
        };

        function startSystem() {
            document.getElementById('init-btn').classList.add('hidden');
            document.getElementById('loading-msg').classList.remove('hidden');
            updateStatus("Starting Camera...");

            // オーディオ起動
            if (typeof userStartAudio !== 'undefined') userStartAudio();

            // カメラ設定 (シンプルに)
            let constraints = {
                video: {
                    facingMode: (location.hostname.includes("github.io")) ? "user" : undefined,
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                },
                audio: false
            };

            video = createCapture(constraints, function(stream) {
                updateStatus("Camera OK. Loading AI...");
                initPoseNet();
            });
            video.hide(); // キャンバスに描くので隠す
            
            // iPad対策
            if(video.elt) {
                video.elt.setAttribute('playsinline', '');
                video.elt.setAttribute('autoplay', '');
            }

            setupSounds();
        }

        function initPoseNet() {
            // PoseNet設定
            let options = {
                architecture: 'MobileNetV1',
                imageScaleFactor: 0.3,
                outputStride: 16,
                flipHorizontal: true,
                minConfidence: 0.3,
                detectionType: 'single'
            };
            
            try {
                poseNet = ml5.poseNet(video, options, () => {
                    updateStatus("AI Ready! Click Start.");
                    document.getElementById('loading-msg').classList.add('hidden');
                    document.getElementById('start-btn').classList.remove('hidden');
                });
                poseNet.on('pose', (results) => { poses = results; });
            } catch(e) {
                updateStatus("AI Error: " + e);
            }
        }

        function gameStart() {
            gameState = 'PLAY';
            score = 0;
            balloons = [];
            
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            
            // BGM再生
            if(bgmNormal && bgmNormal.isLoaded()) {
                bgmNormal.setVolume(0.5);
                bgmNormal.loop();
            }
        }

        function returnTitle() {
            gameState = 'TITLE';
            stopAllSounds();
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
            document.getElementById('init-btn').classList.add('hidden'); // カメラは起動済みなので
            document.getElementById('start-btn').classList.remove('hidden'); // スタートボタンを表示
        }

        // ★★★ P5.js Main ★★★

        function setup() {
            createCanvas(windowWidth, windowHeight);
            
            // リソース読み込み (エラーでも止まらない)
            imgWater = loadImage('water.png');
            imgEnemy1 = loadImage('enemy1.png');
            imgEnemy2 = loadImage('enemy2.png');
            imgBoss = loadImage('boss.png');
            imgBossEnd = loadImage('boss_end.png');
            
            bgmNormal = loadSound('normal_bgm.mp3');
            bgmExtra1 = loadSound('extra1_bgm.mp3');
            bgmBoss = loadSound('boss_bgm.mp3');
            bgmVictory = loadSound('victory.mp3');

            let savedScore = localStorage.getItem('kamehameha_highscore');
            if(savedScore) highScore = parseInt(savedScore);
            document.getElementById('high-score-title').innerText = highScore;
        }

        function setupSounds() {
            osc = new p5.Oscillator('sine'); osc.amp(0); osc.start();
            noiseOsc = new p5.Noise('brown'); noiseOsc.amp(0); noiseOsc.start();
        }

        function stopAllSounds() {
            if(bgmNormal) bgmNormal.stop();
            if(bgmExtra1) bgmExtra1.stop();
            if(bgmBoss) bgmBoss.stop();
            if(bgmVictory) bgmVictory.stop();
        }

        function draw() {
            // 背景をグレーにする（黒だと何も見えないリスクがあるため）
            background(50); 

            // 1. カメラ描画
            if (video && video.width > 0) {
                // アスペクト比を維持して画面いっぱいに表示
                let scale = max(width / video.width, height / video.height);
                let w = video.width * scale;
                let h = video.height * scale;
                let x = (width - w) / 2;
                let y = (height - h) / 2;

                push();
                translate(width, 0); // 左右反転
                scale(-1, 1);
                image(video, -(x + w), y, w, h); 
                pop();
            } else {
                // カメラがない時
                fill(100); textAlign(CENTER); textSize(20);
                text("No Camera Signal", width/2, height/2);
            }

            // 2. 手の位置検出
            trackedPos = [null, null];
            if (poses.length > 0) {
                let p = poses[0].pose;
                // 手首の位置を取得 (信頼度0.2以上)
                if (p.leftWrist.confidence > 0.2) trackedPos[0] = transform(p.leftWrist.x, p.leftWrist.y);
                if (p.rightWrist.confidence > 0.2) trackedPos[1] = transform(p.rightWrist.x, p.rightWrist.y);
            }
            
            // マウスでのデバッグ操作（PC用）
            if (mouseIsPressed) {
                trackedPos[0] = {x: mouseX - 50, y: mouseY};
                trackedPos[1] = {x: mouseX + 50, y: mouseY};
            }

            // 手の描画（デバッグ用：緑と赤の丸）
            noFill(); strokeWeight(5);
            if (trackedPos[0]) { stroke(0,255,0); circle(trackedPos[0].x, trackedPos[0].y, 60); }
            if (trackedPos[1]) { stroke(255,0,0); circle(trackedPos[1].x, trackedPos[1].y, 60); }

            // 3. ゲームループ
            if (gameState === 'PLAY') {
                updateGame();
                drawGame();
            }
            
            // 左上ステータス更新
            let status = "State: " + gameState + " | Score: " + score;
            if(trackedPos[0]) status += " | L-Hand OK";
            if(trackedPos[1]) status += " | R-Hand OK";
            updateStatus(status);
        }

        // カメラ座標を画面座標に変換
        function transform(x, y) {
            if (!video || video.width === 0) return {x:0, y:0};
            let scale = max(width / video.width, height / video.height);
            let w = video.width * scale;
            let h = video.height * scale;
            let videoX = (width - w) / 2;
            let videoY = (height - h) / 2;
            
            // 左右反転を考慮
            let screenX = videoX + (video.width - x) * scale;
            let screenY = videoY + y * scale;
            return { x: screenX, y: screenY };
        }

        function updateGame() {
            // 敵の出現
            if (frameCount % 60 === 0) {
                balloons.push({
                    x: random(50, width-50),
                    y: height + 50,
                    r: 40,
                    speed: 3,
                    type: 'NORMAL'
                });
            }

            // かめはめ波チャージ判定
            if (trackedPos[0] && trackedPos[1]) {
                let d = dist(trackedPos[0].x, trackedPos[0].y, trackedPos[1].x, trackedPos[1].y);
                if (d < 150) {
                    isCharging = true;
                    chargeTimer += 2;
                    if (chargeTimer > 100) {
                        isFiring = true;
                        chargeTimer = 0;
                        fireTimer = 20;
                    }
                } else {
                    isCharging = false;
                    chargeTimer = 0;
                }
            }

            // 発射処理
            if (isFiring) {
                fireTimer--;
                if (fireTimer <= 0) isFiring = false;
            }

            // 敵の移動と当たり判定
            for (let i = balloons.length - 1; i >= 0; i--) {
                let b = balloons[i];
                b.y -= b.speed;
                
                let hit = false;
                // 手でタッチ
                if (trackedPos[0] && dist(trackedPos[0].x, trackedPos[0].y, b.x, b.y) < b.r + 30) hit = true;
                if (trackedPos[1] && dist(trackedPos[1].x, trackedPos[1].y, b.x, b.y) < b.r + 30) hit = true;
                // かめはめ波
                if (isFiring) hit = true;

                if (hit) {
                    score += 10;
                    balloons.splice(i, 1);
                    // 音を鳴らす
                    if(osc) { osc.freq(500); osc.amp(0.5, 0.1); setTimeout(()=>osc.amp(0, 0.1), 100); }
                } else if (b.y < -50) {
                    balloons.splice(i, 1);
                }
            }
        }

        function drawGame() {
            // 敵
            for (let b of balloons) {
                // 画像があれば表示、なければ丸
                if (imgEnemy1 && imgEnemy1.width > 0) {
                    imageMode(CENTER);
                    image(imgEnemy1, b.x, b.y, b.r*2, b.r*2);
                } else {
                    fill(255, 0, 255); noStroke();
                    circle(b.x, b.y, b.r*2);
                }
            }

            // チャージエフェクト
            if (isCharging) {
                let cx = (trackedPos[0].x + trackedPos[1].x) / 2;
                let cy = (trackedPos[0].y + trackedPos[1].y) / 2;
                noFill(); stroke(255, 255, 0); strokeWeight(5);
                circle(cx, cy, chargeTimer * 2);
            }

            // かめはめ波ビーム
            if (isFiring) {
                fill(255, 255, 0, 150); noStroke();
                rect(0, 0, width, height);
            }

            // UI
            fill(255); noStroke(); textSize(30); textAlign(LEFT, TOP);
            text("SCORE: " + score, 20, 20);
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }
    </script>
</body>
</html>