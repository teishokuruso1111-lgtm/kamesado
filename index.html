<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>かめはめ波（Final Release）</title>
    <style>
        /* 背景は黒（カメラロード前用） */
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; color: white; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        
        button { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            border: 3px solid #FFF; padding: 15px 50px; font-size: 24px; font-weight: 900; 
            color: #333; border-radius: 50px; cursor: pointer; margin: 15px; pointer-events: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        button:active { transform: scale(0.95); }

        .screen { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 30px; 
            border: 4px solid #00FF00; box-shadow: 0 0 30px #00FF00; margin-top: 10%; pointer-events: auto;
            width: 90%; max-width: 600px;
        }
        .hidden { display: none !important; }
        
        h1 { color: #00FF00; font-size: 40px; margin: 0 0 20px 0; text-shadow: 0 0 10px white; font-weight: 900; text-align: center; }
        #status-msg { color: #00FF00; font-size: 18px; font-weight: bold; margin-top: 20px; text-align: center; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
</head>
<body>
    <div id="ui-layer">
        <div id="title-screen" class="screen">
            <h1>かめはめ波</h1>
            <p>〜 最終完成版 〜</p>
            <p>High Score: <span id="high-score">0</span></p>
            
            <button onclick="startApp()" id="init-btn">カメラ起動</button>
            <button onclick="gameStart()" id="start-btn" class="hidden">あそぶ！</button>
            
            <div id="status-msg">ボタンを押してね</div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h1 id="result-title">おしまい！</h1>
            <h2 id="final-score" style="color:cyan; font-size:40px;">0</h2>
            <button onclick="resetGame()">タイトルへ</button>
        </div>
        
        <div id="bar-box" style="position:absolute; bottom:20px; width:80%; height:30px; border:2px solid white; border-radius:15px; display:none;">
            <div id="bar" style="width:0%; height:100%; background:orange;"></div>
        </div>
    </div>

    <script>
        // --- 設定 ---
        const CAM_W = 640;
        const CAM_H = 480;
        
        // 画像アスペクト比 (676:369)
        const IMG_RATIO = 369 / 676; 

        // --- 変数 ---
        let video;
        let poseNet;
        let poses = [];
        let trackedPos = [null, null];
        
        let imgWater, imgEnemy1, imgEnemy2, imgBoss, imgBossEnd;
        let audioBGM = new Audio('normal_bgm.mp3'); audioBGM.loop = true;
        let audioExtra = new Audio('extra1_bgm.mp3'); audioExtra.loop = true;
        let audioBoss = new Audio('boss_bgm.mp3'); audioBoss.loop = true;
        let audioWin = new Audio('victory.mp3');
        
        let balloons = [];
        let score = 0;
        let highScore = 0;
        let gameState = 'INIT'; 
        let isCharging=false, isFiring=false, chargeTimer=0, fireTimer=0;
        let extraTimer=0, boss=null, bossIsDead=false, needsSeparation=false;
        let waterSpawned = false, hasCollectedWater = false;
        let timeLeft = 60;

        // ★★★ ボタンアクション ★★★
        function startApp() {
            document.getElementById('init-btn').classList.add('hidden');
            document.getElementById('status-msg').innerText = "カメラ準備中...";
            
            let constraints = {
                video: { width: CAM_W, height: CAM_H },
                audio: false
            };
            // GitHub上ならインカメラ
            if (location.hostname.includes("github.io")) {
                constraints.video.facingMode = "user";
            }

            video = createCapture(constraints, function() {
                console.log("Camera OK");
                document.getElementById('status-msg').innerText = "AI読み込み中...";
                initAI();
            });
            video.size(CAM_W, CAM_H);
            video.hide();
            
            if(video.elt) {
                video.elt.setAttribute('playsinline', '');
                video.elt.setAttribute('autoplay', '');
            }
        }

        function initAI() {
            let options = {
                architecture: 'MobileNetV1', 
                imageScaleFactor: 0.3, 
                outputStride: 16, 
                flipHorizontal: true, 
                minConfidence: 0.5, 
                detectionType: 'single'
            };
            poseNet = ml5.poseNet(video, options, () => {
                console.log("AI Ready");
                document.getElementById('status-msg').innerText = "準備完了！";
                document.getElementById('start-btn').classList.remove('hidden');
            });
            poseNet.on('pose', (results) => { poses = results; });
        }

        function gameStart() {
            gameState = 'PLAY';
            score = 0;
            balloons = [];
            timeLeft = 60;
            hasCollectedWater = false; waterSpawned = false; bossIsDead = false;
            
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('bar-box').style.display = 'block';
            
            stopAllSounds();
            audioBGM.currentTime = 0;
            audioBGM.play().catch(e => console.log("Audio Error: " + e));
        }

        function resetGame() {
            gameState = 'READY';
            stopAllSounds();
            
            // 画面リセット処理
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
            document.getElementById('bar-box').style.display = 'none';
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('init-btn').classList.add('hidden');
            document.getElementById('status-msg').innerText = "いつでもOK";
            
            // 変数リセット
            boss = null;
            balloons = [];
        }

        function stopAllSounds() {
            audioBGM.pause(); audioExtra.pause(); audioBoss.pause(); audioWin.pause();
        }

        function endGame() {
            gameState = 'RESULT';
            stopAllSounds();
            
            // タイトル変更
            let title = bossIsDead ? "完全クリア！" : "タイムアップ";
            document.getElementById('result-title').innerText = title;
            document.getElementById('final-score').innerText = score.toLocaleString();
            
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('bar-box').style.display = 'none';
            
            if(score > highScore) {
                highScore = score;
                localStorage.setItem('kamehameha_highscore', highScore);
                document.getElementById('high-score').innerText = highScore;
            }
        }

        // --- p5.js ---

        function setup() {
            createCanvas(windowWidth, windowHeight);
            
            // 画像読み込み
            imgWater = loadImage('water.png');
            imgEnemy1 = loadImage('enemy1.png');
            imgEnemy2 = loadImage('enemy2.png');
            imgBoss = loadImage('boss.png');
            imgBossEnd = loadImage('boss_end.png');

            let s = localStorage.getItem('kamehameha_highscore');
            if(s) highScore = parseInt(s);
            document.getElementById('high-score').innerText = highScore;
        }

        function draw() {
            background(0); 

            // 1. カメラ描画 (フィルターなし！クリアに見えます)
            if (video && video.width) {
                push();
                translate(width, 0);
                scale(-1, 1);
                let scaleVal = max(width/video.width, height/video.height);
                let w = video.width * scaleVal;
                let h = video.height * scaleVal;
                let x = (width - w) / 2;
                let y = (height - h) / 2;
                // フルカラーで描画
                tint(255, 255); 
                image(video, -(x+w), y, w, h);
                pop();
            } else {
                fill(255); textAlign(CENTER); textSize(20);
                text("Camera Loading...", width/2, height/2);
            }

            // 2. AI更新
            updatePose();

            // 3. ゲーム処理
            if (gameState === 'PLAY' || gameState === 'EXTRA1' || gameState === 'EXTRA2') {
                updateGameLogic();
                drawGame();
            } else {
                drawHands(); // 動作確認用
            }
        }

        function updatePose() {
            trackedPos = [null, null];
            if (poses.length > 0) {
                let p = poses[0].pose;
                if (p.leftWrist.confidence > 0.1) trackedPos[0] = transform(p.leftWrist.x, p.leftWrist.y);
                if (p.rightWrist.confidence > 0.1) trackedPos[1] = transform(p.rightWrist.x, p.rightWrist.y);
            }
            // PCデバッグ用（マウス）
            if (mouseIsPressed) {
                trackedPos[0] = {x: mouseX - 50, y: mouseY};
                trackedPos[1] = {x: mouseX + 50, y: mouseY};
            }
        }

        function transform(x, y) {
            if(!video) return {x:0, y:0};
            let scaleVal = max(width/video.width, height/video.height);
            let w = video.width * scaleVal;
            let h = video.height * scaleVal;
            let vx = (width - w) / 2;
            let vy = (height - h) / 2;
            let sx = vx + (video.width - x) * scaleVal; 
            let sy = vy + y * scaleVal;
            return { x: sx, y: sy };
        }

        function drawHands() {
            noFill(); strokeWeight(5);
            // 自分の動きを確認するためのマーカー
            if (trackedPos[0]) { stroke(0,255,255); circle(trackedPos[0].x, trackedPos[0].y, 50); }
            if (trackedPos[1]) { stroke(255,50,50); circle(trackedPos[1].x, trackedPos[1].y, 50); }
        }

        function updateGameLogic() {
            if (frameCount % 60 === 0) {
                if (gameState === 'PLAY' && timeLeft > 0) timeLeft--;
                if ((gameState === 'EXTRA1' || gameState === 'EXTRA2') && extraTimer > 0) extraTimer--;
            }

            if (gameState === 'PLAY') {
                if (timeLeft <= 20 && !waterSpawned && !hasCollectedWater) {
                    spawnBalloon('WATER'); waterSpawned = true;
                }
                if (timeLeft <= 0) {
                    if (hasCollectedWater) {
                        gameState = 'EXTRA1'; extraTimer = 15; balloons = [];
                        stopAllSounds(); audioExtra.currentTime=0; audioExtra.play();
                    } else {
                        endGame(); // ★修正済み
                    }
                }
            } else if (gameState === 'EXTRA1') {
                if (extraTimer <= 0) {
                    gameState = 'EXTRA2'; extraTimer = 15; balloons = [];
                    boss = { x: width/2, y: height*0.6, w: min(width,height)*0.6, hp: 2, justHit: false };
                    stopAllSounds(); audioBoss.currentTime=0; audioBoss.play();
                }
            } else if (gameState === 'EXTRA2') {
                if (bossIsDead && extraTimer <= 0) endGame();
                else if (!bossIsDead && extraTimer <= 0) endGame();
            }

            // 敵出現
            if (frameCount % 60 === 0) {
                if(gameState === 'PLAY') spawnBalloon('NORMAL');
                if(gameState === 'EXTRA1') spawnBalloon('EXTRA');
            }

            handleKamehameha();

            // 当たり判定
            for (let i = balloons.length - 1; i >= 0; i--) {
                let b = balloons[i];
                b.y -= b.speed;
                let hit = false;
                if(isFiring) hit = true;
                else {
                    if(trackedPos[0] && dist(trackedPos[0].x, trackedPos[0].y, b.x, b.y) < b.r + 30) hit = true;
                    if(trackedPos[1] && dist(trackedPos[1].x, trackedPos[1].y, b.x, b.y) < b.r + 30) hit = true;
                }

                if(hit) {
                    if(b.type === 'WATER') { score += 332; hasCollectedWater = true; }
                    else if(b.type === 'EXTRA') { score += 15; }
                    else { score += 10; }
                    balloons.splice(i, 1);
                } else if(b.y < -50) {
                    balloons.splice(i, 1);
                }
            }

            // ボス処理
            if (gameState === 'EXTRA2' && boss && !bossIsDead) {
                boss.y = height*0.6 + sin(frameCount * 0.05) * 20;
                if (isFiring) {
                    if (!boss.justHit) {
                        boss.hp--; boss.justHit = true;
                        if (boss.hp <= 0) {
                            score += 31000000000; bossIsDead = true; extraTimer = 3;
                            stopAllSounds(); audioWin.currentTime=0; audioWin.play();
                        }
                    }
                } else {
                    boss.justHit = false;
                }
            }
            
            // UI更新
            let bar = document.getElementById('bar');
            if(needsSeparation) { bar.style.width='100%'; bar.style.background='blue'; }
            else if(isCharging) { bar.style.width=chargeTimer+'%'; bar.style.background='orange'; }
            else { bar.style.width='0%'; }
        }

        function handleKamehameha() {
            if(isFiring) {
                fireTimer--;
                if(fireTimer <= 0) { isFiring = false; needsSeparation = true; }
                return;
            }
            if (trackedPos[0] && trackedPos[1]) {
                let d = dist(trackedPos[0].x, trackedPos[0].y, trackedPos[1].x, trackedPos[1].y);
                if (needsSeparation) {
                    if(d > 200) needsSeparation = false;
                } else if (d < 150) {
                    isCharging = true; chargeTimer += 2;
                    if(chargeTimer > 100) { isFiring = true; chargeTimer = 0; fireTimer = 30; isCharging = false; }
                } else {
                    chargeTimer = 0; isCharging = false;
                }
            }
        }

        function spawnBalloon(mode) {
            let type = 'NORMAL';
            let c = color(random(255),random(255),random(255));
            if(mode === 'WATER') { type = 'WATER'; c = color(0,0,255); }
            else if(mode === 'EXTRA') { type = 'EXTRA'; c = color(255,0,0); }
            
            // ★サイズ指定：横幅676pxの比率で計算
            let baseW = 100; // 基準の横幅
            
            balloons.push({ x: random(50, width-50), y: height+50, r: 40, w: baseW, speed: 3, type: type, c: c });
        }

        function drawGame() {
            // 敵
            for (let b of balloons) {
                let img = null;
                if(b.type === 'WATER') img = imgWater;
                else if(b.type === 'EXTRA') img = imgEnemy1;
                else if(b.type === 'NORMAL') img = null; 

                // ★横長の画像描画（比率維持）
                if(img && img.width > 1) {
                    imageMode(CENTER); 
                    // 幅に合わせて高さを計算（676:369）
                    let h = b.w * IMG_RATIO;
                    image(img, b.x, b.y, b.w, h);
                } else {
                    fill(b.c); noStroke(); circle(b.x, b.y, b.r*2);
                }
            }
            // ボス
            if(gameState === 'EXTRA2' && boss) {
                let img = bossIsDead ? imgBossEnd : imgBoss;
                if(img && img.width > 1) {
                    imageMode(CENTER); 
                    // ボスも横長比率で大きく
                    let bossH = boss.w * IMG_RATIO;
                    image(img, boss.x, boss.y, boss.w, bossH);
                } else {
                    fill(255); rect(boss.x-100, boss.y-100, 200, 200);
                }
            }
            // ビーム
            if(isFiring) { fill(255,255,0,150); noStroke(); rect(0,0,width,height); }
            
            drawHands();
            
            fill(255); textSize(30); textAlign(LEFT, TOP); text("SCORE: " + score.toLocaleString(), 20, 20);
            textAlign(RIGHT, TOP); 
            let t = (gameState === 'PLAY') ? timeLeft : extraTimer;
            text("TIME: " + t, width-20, 20);
        }

        function windowResized() { resizeCanvas(windowWidth, windowHeight); }
    </script>
</body>
</html>