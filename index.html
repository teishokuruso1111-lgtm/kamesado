<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>かめはめ波（Rescue Ver）</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; color: white; }
        
        /* ログ表示（原因特定用） */
        #debug-log {
            position: absolute; top: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.5); color: #00FF00; 
            font-size: 12px; z-index: 20000; pointer-events: none;
            white-space: pre-wrap; padding: 5px; border-bottom: 1px solid #444;
        }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        
        button { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            border: 3px solid #FFF; padding: 15px 50px; font-size: clamp(20px, 5vw, 30px); font-weight: 900; 
            color: #333; border-radius: 50px; cursor: pointer; margin: 15px; pointer-events: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        button:active { transform: scale(0.95); }

        .screen-panel { 
            display: none; /* 初期状態はJSで制御 */
            flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 30px; 
            border: 4px solid #00FF00; box-shadow: 0 0 30px #00FF00; margin-top: 5%; pointer-events: auto;
            width: 90%; max-width: 600px; box-sizing: border-box;
        }
        
        /* キャリブレーション画面 */
        #calibration-screen {
            background: none; border: none; box-shadow: none;
            width: 100%; height: 100%; justify-content: space-between;
            padding: 40px; pointer-events: none;
        }
        
        .calib-text {
            color: #FFF; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000;
            background: rgba(0,0,0,0.6); padding: 15px 30px; border-radius: 50px; border: 3px solid #FFF; text-align: center;
            margin-top: 20px; pointer-events: auto;
        }
        
        h1 { color: #00FF00; font-size: clamp(40px, 10vw, 80px); margin: 0 0 20px 0; text-shadow: 0 0 15px white; font-weight: 900; letter-spacing: 5px; text-align: center; }
        p { color: white; font-size: clamp(16px, 4vw, 24px); margin-bottom: 30px; font-weight: bold; text-align: center; line-height: 1.5; }
        .score-val { font-size: clamp(40px, 10vw, 80px); color: #00FFFF; font-weight: 900; text-shadow: 0 0 20px #00FFFF; margin-bottom: 30px; }
        
        #charge-bar-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; height: 30px; background: rgba(255, 255, 255, 0.2); border-radius: 15px; overflow: hidden; display: none; border: 3px solid white; }
        #charge-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #FFFF00, #FF4500); transition: width 0.1s; }
        .credit { margin-top: 20px; font-size: 12px; color: #AAA; text-align: center; }
    </style>

    <script>
        function log(msg) {
            console.log(msg);
            var el = document.getElementById('debug-log');
            if(el) el.innerHTML += msg + " | ";
        }
        window.onerror = function(msg, url, line) {
            log("Err: " + msg);
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
</head>
<body>
    <div id="debug-log">Init...<br></div>

    <div id="ui-layer">
        <div id="title-screen" class="screen-panel" style="display: flex;">
            <h1>かめはめ波</h1>
            <p>〜 佐渡ヶ島 決戦版 〜</p>
            <p style="color:#FFFF00">ハイスコア: <span id="high-score-title">0</span></p>
            
            <button id="btn-start">あそぶ！</button>
            
            <div class="credit">音楽素材：魔王魂 / AR Spark</div>
        </div>

        <div id="calibration-screen" class="screen-panel" style="display: none;">
            <div class="calib-text">白い枠の中に<br>リストバンドを入れて<br>画面をタップ！</div>
            <div style="pointer-events: auto; margin-bottom: 50px;">
                <button id="btn-reset" class="secondary" style="font-size:18px; padding:10px 30px;">タイトルへ戻る</button>
            </div>
        </div>

        <div id="result-screen" class="screen-panel" style="display: none;">
            <h1 id="result-title">おしまい！</h1>
            <div style="font-size: 20px; color:#AAA;">今回のスコア</div>
            <div class="score-val"><span id="final-score">0</span></div>
            <p style="color:#FFFF00">ハイスコア: <span id="high-score-result">0</span></p>
            <button id="btn-return">タイトルへ</button>
        </div>
        
        <div id="charge-bar-container"><div id="charge-bar"></div></div>
    </div>

    <script>
        log("Script Start");

        // --- 設定 ---
        const CAM_W = 640;
        const CAM_H = 480;
        const SKIP_STEP = 4; 
        
        const HUE_THRESH = 20; 
        const SAT_THRESH = 30; 
        const VAL_THRESH = 30; 
        
        const IMG_RATIO = 369 / 676; 

        // --- 変数 ---
        let video;
        let targetHSV = null; 
        let trackedPos = [null, null]; 
        
        let imgWater, imgEnemy1, imgEnemy2, imgBoss, imgBossEnd;
        let bgmNormal, bgmExtra1, bgmBoss, bgmVictory;
        
        let balloons = [];
        let floatingTexts = []; 
        let score = 0;
        let highScore = 0;
        let timeLeft = 60;
        let gameState = 'TITLE'; 
        
        let chargeTimer = 0;
        let isCharging = false;
        let isFiring = false;
        let fireTimer = 0;
        let cooldownTimer = 0;
        let needsSeparation = false; 
        let osc, noiseOsc;

        let hasCollectedWater = false;
        let waterSpawned = false;
        let warningTextX = 0;
        let extraTimer = 0;
        let boss = null;
        let bossIsDead = false;

        // ★ボタンイベント設定（HTML読み込み後に確実に実行）
        window.onload = function() {
            log("Window Loaded");
            document.getElementById('btn-start').onclick = function() {
                log("Start Clicked");
                // オーディオコンテキストの開始
                if (getAudioContext().state !== 'running') {
                    userStartAudio().then(() => log("Audio Started"));
                }
                startCalibration();
            };
            document.getElementById('btn-reset').onclick = returnToTitle;
            document.getElementById('btn-return').onclick = returnToTitle;
        };

        // --- 画面切り替えヘルパー ---
        function showScreen(id) {
            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('calibration-screen').style.display = 'none';
            document.getElementById('result-screen').style